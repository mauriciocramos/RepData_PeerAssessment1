---
title: "Reproducible Research: Peer Assessment 1"
author: "Maurício Collaça"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setlocale(category = "LC_ALL", locale = "us")
```

**************
# Introduction

It is now possible to collect a large amount of data about personal movement using activity monitoring devices such as a Fitbit, Nike Fuelband, or Jawbone Up. These type of devices are part of the “quantified self” movement – a group of enthusiasts who take measurements about themselves regularly to improve their health, to find patterns in their behavior, or because they are tech geeks. But these data remain under-utilized both because the raw data are hard to obtain and there is a lack of statistical methods and software for processing and interpreting the data.

This assignment makes use of data from a personal activity monitoring device. This device collects data at 5 minute intervals through out the day. The data consists of two months of data from an anonymous individual collected during the months of October and November, 2012 and include the number of steps taken in 5 minute intervals each day.

The data for this assignment can be downloaded from the course web site:

Dataset: [Activity monitoring data][1] [52K]

[1]: https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip

The variables included in this dataset are:

`step`: Number of steps taking in a 5-minute interval (missing values are coded as NA)  
`date`: The date on which the measurement was taken in YYYY-MM-DD format  
`interval`: Identifier for the 5-minute interval in which measurement was taken  
The dataset is stored in a comma-separated-value (CSV) file and there are a total of 17,568 observations in this dataset.

************************************
# Loading and preprocessing the data

This research requires additional R packages installed and loaded.

```{r, echo=TRUE, message=FALSE}
library(dplyr); library(tidyr); library(ggplot2); library(lubridate)
```

The versions used in this research are dplyr `r packageVersion("dplyr")`, tidyr `r packageVersion("tidyr")`, ggplot2 `r packageVersion("ggplot2")` and lubridate `r packageVersion("lubridate")`.

The dataset zip file is automatically downloaded and uncompressed in case it's not already available locally.

```{r}
url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip"
destfile = "activity.zip"
if (!file.exists(destfile)) download.file(url, destfile, mode = "wb", cacheOK = FALSE, quiet = TRUE)
if (!file.exists("activity.csv") & file.exists(destfile)) unzip(destfile, setTimes = TRUE)
```

Import data columns with appropriate R classes and values: steps and interval as `integer` data type, date as `Date` data type and "NA" strings as `NA` values.

```{r}
activity <- read.csv("activity.csv", colClasses = c("integer", "Date", "integer"))
glimpse(activity)
```

******************************************
# What is the mean total number of steps taken per day?

## Total number of steps each day

```{r}
daily <- activity %>% group_by(date) %>% summarise(total.steps = sum(steps, na.rm = TRUE)) %>% as.data.frame
glimpse(daily)
```

## Histogram of the total steps each day

**Frequency histogram.**

```{r Frequency-histogram-total-steps-each-day}
ggplot(daily, aes(x = total.steps)) +
    geom_histogram(binwidth = 1000, color = "dark red", size = 1, fill = "dark red", alpha = 0.5) +
    geom_vline(aes(xintercept=mean(daily$total.steps), linetype="Mean", size = "Mean"), color="red") +
    geom_vline(aes(xintercept=median(daily$total.steps), linetype="Median", size = "Median"), color = "dark red") +
    scale_linetype_manual(name = NULL, values = c("solid","dotted")) +
    scale_size_manual(name = NULL, values = c(1, 1.1)) +
    scale_x_continuous(breaks=seq.int(0, 22000, by = 2000)) +
    scale_y_continuous(breaks=0:(22000/2000-1)) +
    xlab("total steps each day") +
    ggtitle("Frequency histogram of the total steps each day") +
    theme(legend.position = c(0.9, 0.85))
```

**Density histogram.**

```{r Density-histogram-total-steps-each-day}
ggplot(daily, aes(x = total.steps)) +
    geom_histogram(aes(y = ..density..), binwidth = 1000, color = "dark red", size = 1, fill = "dark red", alpha=0.5) +
    geom_density(aes(colour = "Kernel density"), size = 1, fill = "dark red", alpha = 0.3) +
    stat_function(fun = dnorm,
                  args = list(mean = mean(daily$total.steps), sd = sd(daily$total.steps)),
                  aes(colour = "Normal curve"), size = 1) +
    scale_colour_manual(name = NULL, values = c("dark red", "red")) +
    geom_vline(aes(xintercept=mean(daily$total.steps), linetype = "Mean", size = "Mean"), color = "red") +
    geom_vline(aes(xintercept=median(daily$total.steps), linetype = "Median", size = "Median"), color = "dark red") +
    scale_linetype_manual(name = NULL, values = c("solid", "dotted")) +
    scale_size_manual(name = NULL, values = c(1, 1.1)) +
    scale_x_continuous(breaks=seq.int(0, 22000, by = 2000)) +
    xlab("total steps each day") +
    ggtitle("Density histogram of the total steps each day") +
    theme(legend.position = c(0.9, 0.75))
```

## Mean and median of the total number of steps taken per day

**Mean.**

```{r}
mean(daily$total.steps)
```

**Median.**

```{r}
median(daily$total.steps)
```

********************************
# What is the average daily activity pattern?

## Time series plot

Time series plot of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)

**Data transformation.**

```{r}
interval2seconds <- function(interval) {trunc(interval/100) * 60 * 60 + (interval %% 100)*60}
five <- activity %>% group_by(interval) %>% summarise(mean.steps = mean(steps, na.rm = TRUE)) %>% mutate(seconds = interval2seconds(interval)) %>% as.data.frame
glimpse(five)
```

**Plotting.**

```{r Average-daily-activity-pattern}
breaks <- seq(0, 86400, length.out = 13)
labels <- strftime(as.POSIXct(breaks, tz="GMT", origin="1970-01-01"), format = "%H:%M", tz="GMT")
ggplot(five, aes(seconds, mean.steps)) +
    scale_x_time(breaks = breaks, labels = labels) +
    geom_line(size=1, aes(colour="Average steps")) +
    geom_point(color = "black", size=2, pch = 21, alpha=0.5) +
    geom_smooth(size = 0.1, method="lm", aes(colour="Linear trend")) +
    geom_smooth(size = 0.1, method="loess", aes(colour = "Polynomial trend")) +
    geom_rug(sides="l", color = "dark green") +
    scale_colour_manual(name = 'Series', values=c("dark green", "dark red", "blue")) +
    ggtitle("Average daily activity pattern in 5 minutes intervals") +
    ylab("Average Steps") + xlab("time of the day") +
    theme(legend.position = c(0.85, 0.8))
```

## Maximum number of steps interval

Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?

```{r}
(maxInterval <- with(five,interval[which.max(mean.steps)]))
```

*************************
# Imputing missing values

Note that there are a number of days/intervals where there is missing values (coded as NA). The presence of missing days may introduce bias into some calculations or summaries of the data.

## Total number of missing values in the dataset

```{r}
(missingValuesTotal <- sum(is.na(activity$steps)))
```

Proportion of the missing values.

```{r}
(missingValueRatio <- mean(is.na(activity$steps)))
```

This proportion of the dataset observations is considered high and deserves an exploration of the missing data pattern.

## Strategy for filling in all of the missing values in the dataset

The strategy for filling in all of the missing values in the dataset does not need to be sophisticated. For example, one can use the mean/median for that day, or the mean for that 5-minute interval, etc.

According to Peng (2016), in the book [Exploratory Data Analysis](https://leanpub.com/exdata):

_"Determine the reason for the missing data; what is the process that lead to the data
being missing? Is the proportion of missing values so high as to invalidate any sort of analysis? Is there information in the dataset that would allow you to predict/infer the values of the missing data?"_

This research scope didn't cover reviewing published information about the reasons of the missing data of this specific dataset, one can presume a non-exhaustive hypothesis list:

* The device may fail to collect and store raw data or run out of battery.  
* The test subject forget either to charge or switch on the device during the experiment period.  
* The process to collect data from the device and build the raw dataset may fail.
* The data was removed from the dataset for educational and testing purposes.

After the upcoming imputation experiment one can compare the impact of the change over the missing  data.

The missing data represents `r sprintf("%1.2f%%", 100*missingValueRatio)` of the dataset observations which, although is considered high, possibly would not invalidate analysis based on this dataset.

### Missing data patterns

The following plots help to understand the missing data patterns.

#### Heatmap of daily activity pattern in 5 minutes intervals

Transform the long form (`r nrow(activity)`x`r length(activity)`) dataset in a wide form matrix.

```{r}
intervalMatrix <- activity %>% spread(key = interval, value = steps) %>% mutate(date = NULL) %>% as.matrix
```

This new data format (`r nrow(intervalMatrix)`x`r ncol(intervalMatrix)` ) features `r nrow(intervalMatrix)` days as observations and `r ncol(intervalMatrix)` five-minutes intervals as variables.

Previewing 10 rows by 10 columns.

```{r}
intervalMatrix[1:10,1:10]
```

Plotting a matrix heatmap image where some missing values can be visually identified.

```{r Heatmap-daily-activity-pattern}
colors<-length(unique(as.vector(intervalMatrix)))
par(mar=c(4, 4, 4, 2))
image(1:ncol(intervalMatrix),
      1:nrow(intervalMatrix), ylim=c(nrow(intervalMatrix),1),
      t(intervalMatrix),
      xlab = paste0(ncol(intervalMatrix)," five-minutes intervals"),
      ylab = paste0(nrow(intervalMatrix)," days"),
      col = heat.colors(colors),
      main = "Heatmap of daily activity pattern in 5 minutes intervals")
mtext("(full horizontal lines are missing data days)")
```

One can clearly see in the white horizontal lines that there is missing data at full days.  It will be checked whether missing data also occurs during parts of the days.

#### Total number of missing data intervals each day

**Data transformation.**

```{r}
missingDaily <- activity %>% group_by(date) %>% summarise(missing.intervals = sum(is.na(steps))) %>% as.data.frame
glimpse(missingDaily)
```

Plotting a bar chart with the total number of missing values per day.

```{r Missing-data-intervals}
breaks <- as.Date(which(missingDaily$missing.intervals!=0), origin=missingDaily$date[1]-1)
dayLabels <- strftime(breaks, format = "%a, %d/%m", tz="GMT")
ggplot(missingDaily, aes(date, missing.intervals)) +
    geom_col(fill = "dark red", color = "black") +
    ggtitle("Total number of missing data intervals each day") +
    scale_y_continuous(breaks = seq.int(0, 288, length.out = 5)) +
    ylab("missing intervals") + xlab("days with missing data") +
    scale_x_date(breaks = breaks, labels = dayLabels, date_minor_breaks = "1 days", minor_breaks = NULL) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

Whatever are the reasons of the missing data days, there are some noticeable facts:

1. They happen only on eight full days
2. They happen on the first and last days of the experiment.
3. They happen on the first two Mondays.
4. They happen on two adjacent days only once.

#### Histogram of the missing data days per week day

The following histogram shows the frequency of missing data days per week day:

```{r Histogram-missing-data-weekday}
breaks <- wday(breaks)
wdayLabels <- wday(1:7, label=TRUE)
ggplot(mapping = aes(breaks)) +
    geom_histogram(binwidth = 0.5, fill = "dark red", color = "black") +
    scale_x_continuous(breaks = 1:7, labels = wdayLabels) +
    xlab("Week days") + ylab("total days") +
    ggtitle("Histogram of the missing data days per week day")
```

Based on this distribution it's being assumed that missing data days occur at random.

As there are only full missing data days, there is no point to perform a deeper analysis to identify missing data patterns within days.

### Imputation technique

This research will use the single imputation using mean substitution technique.

_"Involves replacing any missing value with the mean of that variable for all other cases, which has the benefit of not changing the sample mean for that variable. However, mean imputation attenuates any correlations involving the variable(s) that are imputed. This is because, in cases with imputation, there is guaranteed to be no relationship between the imputed variable and any other measured variables. Thus, mean imputation has some attractive properties for univariate analysis but becomes problematic for multivariate analysis."_ [Wikipedia][2], 2017.

[2]: https://en.wikipedia.org/wiki/Imputation_(statistics)#Imputation_techniques

One can assume that the mean substitution is an adequate technique because this research is about the unique variable `steps`, so, univariate data.

To impute the missing 5-minutes intervals with their respective average across all days is less biased than with just a single overall average.  The following table compares the different averages.

Steps statistics                                                   |R code|Result
-------------------------------------------------------------------|------|:---:
Mean of the overall sample|`mean(activity$steps, na.rm=TRUE)`|`r mean(activity$steps, na.rm=TRUE)`|
Median of the overall sample|`median(activity$steps, na.rm=TRUE)`|`r median(activity$steps, na.rm=TRUE)`|
Mean of the total number of steps taken per day distributed in 5 minutes|`mean(daily$total.steps, na.rm = TRUE)/17280`|`r mean(daily$total.steps, na.rm = TRUE)/17280`|
Median of the total number of steps taken per day distributed in 5 minutes|`median(daily$total.steps, na.rm = TRUE)/17280`|`r median(daily$total.steps, na.rm = TRUE)/17280`|
**Average daily activity pattern in 5-minutes intervals**|`lapply(with(activity,split(steps,interval)),mean,na.rm=T)`|**288 values**

Quantiles of the *Average daily activity pattern in 5-minutes intervals*.

```{r}
summary(five$mean.steps)
```

## Imputed dataset

Create a new dataset that is equal to the original dataset but with the missing data filled in.

Replacing the missing values with the *Average daily activity pattern in 5-minutes intervals* for that interval.

```{r}
activityImputed <- activity %>% left_join(five) %>% mutate(steps = coalesce(steps, as.integer(round(mean.steps))), mean.steps=NULL, seconds=NULL)
glimpse(activityImputed)
```

## Make a histogram of the new total number of steps taken each day after mean substitution

**Total number of steps taken each day after mean substitution**

```{r}
dailyImputed <- activityImputed %>% group_by(date) %>% summarise(total.steps = sum(steps, na.rm = TRUE))
glimpse(dailyImputed)
```

**Frequency histogram of the total steps each day after mean substituion.**

```{r Frequency-histogram-total-steps-each-day-after-imputation}
ggplot(dailyImputed, aes(x = total.steps)) +
    geom_histogram(binwidth = 1000, color = "dark green", size = 1, fill = "dark green", alpha=0.5) +
    geom_vline(aes(xintercept=mean(dailyImputed$total.steps),
                   linetype = "Mean", size = "Mean"), color = "green") +
    geom_vline(aes(xintercept=median(dailyImputed$total.steps),
                   linetype = "Median", size = "Median"), color = "dark green") +
    scale_linetype_manual(name = NULL, values = c("solid", "dotted")) +
    scale_size_manual(name = NULL, values = c(1, 1.1)) +
    scale_x_continuous(breaks=seq.int(0, 22000, by = 2000)) +
    scale_y_continuous(breaks=0:(22000/2000+4)) +
    xlab("total steps each day") +
    ggtitle("Frequency histogram of total the steps each day after mean substitution") +
    theme(legend.position = c(0.9, 0.85))
```

**Do these values differ from the estimates from the first part of the assignment?**

One can see the the mean has become closer to the median.

**What is the impact of imputing missing data on the estimates of the total daily number of steps?**

The original mean of the total number of steps taken per day has changed from `r round(mean(daily$total.steps))` to:

```{r}
round(mean(dailyImputed$total.steps))
```

The original median of the total number of steps taken per day has changed from `r as.integer(round(median(daily$total.steps)))` to:

```{r}
round(median(dailyImputed$total.steps))
```

The density histograms shows the changes in the kernel density and the sample normal distribution.

**Density histogram of the total steps each day after mean substitution.**

```{r Density-histogram-total-steps-each-day-after-imputation}
ggplot(dailyImputed, aes(x = total.steps)) +
    geom_histogram(aes(y = ..density..),
                   binwidth = 1000, color = "dark green", size = 1, fill = "dark green", alpha=0.5) +
    geom_density(aes(colour = "Kernel density"), size = 1, fill = "dark green", alpha = 0.3) +
    stat_function(fun = dnorm,
              args = list(mean = mean(dailyImputed$total.steps), sd = sd(dailyImputed$total.steps)),
              aes(colour = "Normal curve"), size = 1) +
    scale_colour_manual(name = NULL, values = c("dark green", "green")) +
    geom_vline(aes(xintercept=mean(dailyImputed$total.steps), linetype = "Mean", size = "Mean"), color = "green") +
    geom_vline(aes(xintercept=median(dailyImputed$total.steps), linetype = "Median", size = "Median"), color = "dark green") +
    scale_linetype_manual(name = NULL, values = c("solid", "dotted")) +
    scale_size_manual(name = NULL, values = c(1, 1.1)) +
    scale_x_continuous(breaks=seq.int(0, 22000, by = 2000)) +
    xlab("total steps each day") +
    ggtitle("Density histogram of the total steps each day after mean substitution") +
    theme(legend.position = c(0.9, 0.75))
```

**Overlaid density histograms of the total steps each day after imputation**

Merging histogram data.

```{r}
merged <- bind_rows(daily %>% select(total.steps) %>% mutate(state = "Former"), dailyImputed %>% select(total.steps) %>% mutate(state = "Imputed")) %>% mutate(state=as.factor(state))
```

Plotting.

```{r Overlaid-density-histograms-after-imputation}
ggplot(merged, aes(x = total.steps)) +
    geom_histogram(aes(y = ..density.., colour = state, fill = state), binwidth = 1000, alpha = 0.5, position = "dodge", size = 1) +
    geom_density(aes(colour = state, fill = state), alpha = 0.3, size = 1) +
    scale_fill_manual(name = "Histograms", values = c("dark red", "dark green")) +
    scale_colour_manual(name = "Histograms", values = c("dark red", "dark green")) +
    stat_function(fun = dnorm, args = list(mean = mean(daily$total.steps), sd = sd(daily$total.steps)),
                  size = 1, color = "red", linetype = "solid") +
    stat_function(fun = dnorm, args = list(mean = mean(dailyImputed$total.steps), sd = sd(dailyImputed$total.steps)),
                  size = 1, color = "green", linetype = "solid") + 
    scale_x_continuous(breaks=seq.int(0, 22000, by = 2000)) +
    xlab("total steps each day") +
    ggtitle("Overlaid density histograms of the total steps each day after imputation") +
    theme(legend.position = c(0.9, 0.60))
```

***************************************************************************
# Are there differences in activity patterns between weekdays and weekends?

For this part the weekdays() function may be of some help here. Use the dataset with the filled-in missing values for this part.

## Weekdays and weekend factors

Create a new factor variable in the dataset with two levels – “weekday” and “weekend” indicating whether a given date is a weekday or weekend day.

```{r}
activityImputed <- activityImputed %>% mutate(dayType=as.factor(ifelse(wday(date)%%6==1,"weekend","weekday")))
glimpse(activityImputed)
```

## Five-minute interval average steps across all weekdays or weekends

Make a panel plot containing a time series plot (i.e. type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all weekday days or weekend days (y-axis).

**Data transformation.**

```{r}
fiveImputed <- activityImputed %>% group_by(dayType, interval) %>% summarise(mean.steps = mean(steps, na.rm = TRUE)) %>% mutate(seconds = interval2seconds(interval)) %>% as.data.frame
glimpse(fiveImputed)
```

**Plotting.**

```{r Average-daily-activity-pattern-weekdays-weekends}
breaks <- seq(0, 86400, length.out = 13)
labels <- strftime(as.POSIXct(breaks, tz="GMT", origin="1970-01-01"), format = "%H:%M", tz="GMT")
ggplot(fiveImputed, aes(seconds, mean.steps, colour = dayType)) +
    scale_x_time(breaks = breaks, labels = labels) +
    geom_line(size=1) +
    #geom_point(color = "black", size=2, pch = 21, alpha=0.5) +
    #geom_smooth(size = 0.1, method="lm", aes(colour="Linear trend")) +
    geom_smooth(size = 0.1, method="loess") +
    #geom_rug(sides="l", color = "dark green") +
    scale_colour_manual(name = "Type of day", values=c("dark red", "blue")) +
    ggtitle("Average daily activity pattern in 5 minutes intervals on week days and weekends") +
    ylab("Average Steps") + xlab("time of the day") +
    theme(legend.position = c(0.9, 0.85))
```

By eyeball, one can see differences in activity patterns between weekdays and weekends:

* During week days, the average is roughly greater from 5am-9am and 6pm-7pm.
* During the weekends, the average is roughly greater from 10am-6pm and 7pm-10pm.

The intersections of the trendlines show an alternative answer to the question:

* During week days, the average is roughly greater from 2am to 10am.
* During the weekends, the average is roughly greater from 10am-10pm.
